# 3D 音频 HRTF 控制器

一个实时 3D 空间音频处理应用程序，使用头部相关传输函数（HRTF）技术将系统音频转换为沉浸式双耳音频。非常适合 ASMR、音乐聆听、游戏以及任何受益于空间定位的音频体验。

## 为什么制作这个应用

在听有声读物时，我发现容易犯困。由于最近在研究空间音频，我创建了一个类似空间音频的效果。因为它使用了人耳模型，所以最好用耳机体验。

然后在听 YouTube ASMR 时，我发现添加这个效果会让体验更加沉浸和刺激。对于某些特殊的视频，效果可能相当显著...

## 功能特性

- **实时处理**：以低延迟实时捕获和处理系统音频
- **基于 HRTF 的空间音频**：使用预计算的 HRTF 数据创建真实的 3D 音频定位
- **交互式控制**：实时调整方位角（0-360°）和仰角（-40° 到 90°）
- **自动旋转**：以可调节速度自动旋转音频位置
- **跨平台支持**：支持 Windows 和 macOS
- **虚拟音频设备集成**：无缝捕获系统音频输出

## 系统要求

- **操作系统**：Windows 10/11 或 macOS 10.14+
- **音频设置**：
  - Windows：VB-CABLE 虚拟音频驱动
  - macOS：BlackHole 2ch 虚拟音频驱动
- **硬件**：建议使用耳机以获得最佳体验
- **Python**：Python 3.8+（如果从源码运行）

## 安装

### 步骤 1：安装虚拟音频驱动

#### macOS
1. 从以下地址下载 BlackHole 2ch：https://existential.audio/blackhole/download/
2. 安装 BlackHole 2ch
3. 在系统偏好设置 > 声音中，将 BlackHole 2ch 设置为音频输出设备

#### Windows
1. 从以下地址下载 VB-CABLE：https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack45.zip
2. 安装 `VBCABLE_Setup_x64.exe`
3. 在声音设置中，将 'CABLE Input' 设置为默认播放设备

### 步骤 2：运行应用程序

#### 选项 A：使用预构建的可执行文件
- 下载适合您平台的最新版本
- 运行可执行文件（无需安装）

#### 选项 B：从源码运行
```bash
# 安装依赖
pip install numpy sounddevice PySide6

# 运行应用程序
python main.py
```

## 使用方法

### 基本操作

1. **启动应用程序**：启动 3D 音频 HRTF 控制器
2. **验证设置**：检查状态标签 - 应显示"Virtual Audio: OK"
3. **播放音频**：从系统播放任何音频（音乐、视频、游戏等）
4. **调整位置**：使用滑块控制音频位置：
   - **方位角**：水平位置（0° = 前方，90° = 右侧，180° = 后方，270° = 左侧）
   - **仰角**：垂直位置（-40° = 下方，0° = 水平，90° = 上方）

### 控制说明

- **方位角滑块**：水平旋转音频源（0-360°）
- **仰角滑块**：调整垂直位置（-40° 到 90°）
- **自动旋转复选框**：启用/禁用自动旋转
- **速度控制**：调整旋转速度（1-180°/秒）
- **重置位置**：返回到中心位置（0°, 0°）并停止自动旋转
- **输出设备**：选择您首选的音频输出设备

### 最佳体验提示

- **使用耳机**：HRTF 效果在耳机上效果最佳，因为它们提供适当的声道分离
- **从自动旋转开始**：启用自动旋转以立即体验 3D 效果
- **调整速度**：尝试不同的旋转速度以找到最沉浸的感觉
- **尝试不同位置**：手动调整方位角和仰角以精确定位声音

## 工作原理

### 概述

应用程序通过虚拟音频设备捕获系统音频输出，应用基于 HRTF 的空间音频处理，并将处理后的音频输出到您的扬声器或耳机。

### 技术细节

#### 1. 音频捕获
- **输入源**：虚拟音频设备（Windows 上的 VB-CABLE，macOS 上的 BlackHole）
- **采样率**：48 kHz
- **声道**：立体声（2 声道）
- **块大小**：512 采样（低延迟处理）

#### 2. HRTF 处理

**HRTF（头部相关传输函数）**是一个数学模型，描述声波如何与人类头部、耳朵和躯干相互作用。它捕获：
- **双耳时间差（ITD）**：双耳之间的时间延迟
- **双耳电平差（ILD）**：双耳之间的音量差异
- **频谱线索**：来自头部和耳朵形状的频率相关滤波

**处理流程**：
1. **HRTF 查找**：对于每个音频位置（方位角、仰角），从预计算的数据库中找到最匹配的 HRTF
2. **空间定位**：对左右声道应用 ±30° 偏移以创建立体声分离
3. **卷积**：将输入音频与每个耳朵的 HRTF 脉冲响应（FIR 滤波器）进行卷积
4. **重叠相加**：使用重叠缓冲区处理卷积尾部并保持音频连续性
5. **增益控制**：应用增益（0.3）以防止削波并优化输出电平

#### 3. 音频输出
- **输出设备**：用户可选择的音频输出设备
- **格式**：32 位浮点，立体声
- **实时**：基于回调的低延迟流处理

### 音频处理流程

```
系统音频输出
    ↓
虚拟音频设备（VB-CABLE/BlackHole）
    ↓
输入流（以 48kHz、512 采样/块捕获）
    ↓
HRTF 处理：
  - 找到当前位置最接近的 HRTF
  - 应用空间定位（±30° 偏移）
  - 与左右耳滤波器进行卷积
  - 处理重叠相加以保持连续性
    ↓
增益控制（0.3 倍）
    ↓
输出流（播放到选定设备）
    ↓
您的耳机/扬声器
```

### HRTF 数据

应用程序使用存储在 `assets/` 目录中的预计算 HRTF 数据：
- **hrtf_params.txt**：包含每个测量的方位角和仰角参数
- **hrtf_left.f32**：所有方向的左耳脉冲响应（FIR 滤波器）
- **hrtf_right.f32**：所有方向的右耳脉冲响应（FIR 滤波器）

这些文件包含来自 KEMAR（Knowles Electronics Manikin for Acoustic Research）假人头部的测量数据，提供了标准的 HRTF 数据集。

### 位置控制

- **方位角（0-360°）**：围绕听者的水平角度
  - 0° = 前方
  - 90° = 右侧
  - 180° = 后方
  - 270° = 左侧

- **仰角（-40° 到 90°）**：垂直角度
  - -40° = 水平面下方
  - 0° = 水平面
  - 90° = 正上方

### 自动旋转

自动旋转功能基于以下因素持续更新方位角：
- **旋转速度**：每秒度数（可配置 1-180°/秒）
- **基于时间**：使用系统时间计算平滑旋转
- **线程安全**：在单独线程中运行，使用 Qt 信号进行更新

## 技术规格

- **音频格式**：32 位浮点，48 kHz 采样率
- **处理**：实时卷积与重叠相加
- **延迟**：约 10-20ms（取决于块大小）
- **HRTF 数据库**：KEMAR 测量数据
- **GUI 框架**：PySide6 (Qt6)
- **音频 I/O**：sounddevice (PortAudio)

## 限制

- 目前仅支持 Windows 和 macOS
- 需要安装虚拟音频驱动
- 最好使用耳机体验
- 固定增益级别（当前版本中不可用户调节）
- HRTF 数据基于平均头部测量（可能因个人而异）

## 未来改进

未来版本的潜在增强功能：
- 用户可调节的增益控制
- 常见场景的预设位置
- 音频可视化（频谱、3D 位置显示）
- 支持额外的 HRTF 数据集
- Linux 支持
- 录制/导出功能

## 许可证

[在此添加您的许可证信息]

## 贡献

[如果适用，添加贡献指南]

## 致谢

- HRTF 数据基于 KEMAR 测量
- 虚拟音频驱动：BlackHole (macOS) 和 VB-CABLE (Windows)
- 音频处理库：NumPy、sounddevice

